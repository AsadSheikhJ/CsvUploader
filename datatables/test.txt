<?php

namespace App\Controllers;

use CodeIgniter\Controller;
use Config\Database;

class MyController extends Controller
{
    public function dataTable()
    {
        // Get the request object
        $request = $this->request;

        // Get the draw value from the request
        $draw = $request->getGet('draw');

        // Get the start and length values from the request
        $start = $request->getGet('start');
        $length = $request->getGet('length');

        // Get the search value from the request
        $search = $request->getGet('search')['value'];

        // Get the table name from the request
        $table = $request->getGet('table');

        // Get the column name from the request
        $column = $request->getGet('column');

        // Connect to the database
        $db = Database::connect();

        // Build the SELECT query
        $selectQuery = "SELECT * FROM $table WHERE $column LIKE ? LIMIT ?, ?";

        // Execute the SELECT query
        $data = $db->query($selectQuery, ["%$search%", (int)$start, (int)$length])->getResultArray();

        // Build the COUNT query
        $countQuery = "SELECT COUNT(*) FROM $table";

        // Execute the COUNT query
        $totalRecords = $db->query($countQuery)->getRowArray()[0];

        // Build the COUNT query with search criteria
        $countSearchQuery = "SELECT COUNT(*) FROM $table WHERE $column LIKE ?";

        // Execute the COUNT query with search criteria
        $totalFiltered = $db->query($countSearchQuery, ["%$search%"])->getRowArray()[0];

        // Build the response
        $response = [
            'draw' => $draw,
            'recordsTotal' => $totalRecords,
            'recordsFiltered' => $totalFiltered,
            'data' => $data
        ];

        // Return the response as JSON
        return $this->response->setJSON($response);
    }
}